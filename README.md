# Домашнее задание №1 #

![Scheme](CLI.png)

Глобально проект можно разделить на 3 независимых модуля: `AST CONSTRUCTOR`, `INTERPRETER` и `FUNCTION CALLER`:

- `CLI` — сам shell, окно ввода команды.
- `AST CONSTRUCTOR` — принимает строку и выдает дерево разбора. Не хранит состояния.
- `INTERPRETER` — принимает дерево разбора и проходится по нему, отправляя запросы к модулю вызова функций, и отдает результат выполнения. Хранит состояние.
- `FUNCTION CALLER` — принимает запрос от интерпретатора и отдавая результат их выполнение. Не хранит состояния.

Каждый из больших модулей можно разбить на несколько меньших:

`AST CONSTRUCTOR`:

- Lexer — принимает на вход строку и выдает список токенов.
  Токены бывают 5 разных типов:

  - *variableLiteral* — токен, соответствующий присваиванию какой-либо переменной. Может начинаться с английском буквы, и состоять из цифр или букв, и заканчивающийся знаком равенства.
  - *stringLiteral* — токен, соответствующий какой-либо переменной. Может начинаться с английском буквы, и состоять из цифр или букв.
  - *substitutionOperator* — токен, соответствующий оператору подстановки. Состоит из символа `$` и последовательности из букв и цифр после.
  - *pipeOperator* — токен, соответствующий оператору `pipe`. Состоит только из символа `|`.
  - *quotedLiteral* — токен, соответствующий строке кавычке или двойной кавычке. Состоит из символов `'` и `"`.

- Parser — принимает на вход список токенов и выдает дерево разбора. В дереве разбора есть следующие виды выражений:
  - *AssignmentExpr*
  - *FunctionExpr*
  - *ArgExpr*
  - *PipeExpr*
  - *SubstitutionExpr*
  - *QuotedExpr*

Тип выражения выводится по следующим правилам: в строке задается какое-то число команд, разделенных *pipeExpr*. Каждая команда
состоит из нескольких, возможно 0, идущих сначала *AssignmentExpr*, затем, возможно *FunctionExpr*, и 0 или более *ArgumentExpr*, если *FunctionExpr*
присутствует. *FunctionExpr*, *ArgExpr* или *AssignmentExpr* могут содержать *SubstitutionExpr* или *QuotedExpr* в своем составе.

Токены и дерево разбора также дополнительно описаны на картинке.

`INTERPRETER`:

- ENV HANDLER — хранит в хэш-таблице по имени переменных окружения их значения.
- TRAVERSER — обходит дерево разбора и посылает запросы к FUNCTION CALLER.

Задача этого модуля пройтись по AST, собирая команды между `pipe`'ами. После сбора команды, должна произойти дополнительная стадия подстановки
*SubstitutionExpr* в ENV_HANDLER, после которой если все вхождения выражений подстановки должны замениться на непосредственные значения. При этом если
подставляется *QuotedExpr*, то внешние кавычки снимаются, если они есть. Также *FunctionExpr* мог стать более, чем одним токеном. В таком случае мы должны дополнительно посмотреть на появившиеся токены после первого, и записать их в начало списка аргументов, который в дальнейшем отправится `FUNCTION CALLER`'у.

Хэш-таблица и запросы также дополнительно описаны на картинке.

`FUNCTION CALLER`:

- Хранит хэш таблицу из имени в известные заранее заданные функции

При этом его можно подразбить на 2 модуля:

- *INTERNAL CALLER*
  - Хранит реализации известных функций (exit, pwd, ...)
- *EXTERNAL CALLER*
  - Если на исполнение пришла неизвестная функция, то пытаемся найти исполняемый файл в заранее заданных директориях (PATH, например).
  - При запуске функции важно вызвать ее в отдельном подпроцессе (например, воспользовавшись fork-exec-idiom), чтобы падение вызываемого файла не привело к падению нашей оболочки.
